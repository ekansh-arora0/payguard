name: PayGuard CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  privacy-check:
    runs-on: ubuntu-latest
    name: Privacy Compliance
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Run Privacy Scanner
      run: |
        echo "Running PayGuard Privacy Scanner..."
        python scripts/privacy_scanner.py

  lint:
    runs-on: ubuntu-latest
    name: Lint & Format Check
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linters
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort

    - name: Run flake8
      run: flake8 backend/ --max-line-length=120 --ignore=E501,W503,E203 --count --show-source --statistics

    - name: Check formatting (black)
      run: black --check --diff backend/

    - name: Check import order (isort)
      run: isort --check-only --diff backend/

  test-python:
    runs-on: ubuntu-latest
    needs: [privacy-check, lint]
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio
    
    - name: Run unit tests
      env:
        MONGO_URL: mongodb://localhost:27017
        DB_NAME: payguard_test
        ENTERPRISE_API_TOKEN: ci-test-token
      run: |
        python -m pytest test_simple_unit.py tests/test_auth.py tests/test_risk_engine.py tests/test_server.py tests/test_enterprise.py -v --tb=short -x --override-ini="addopts="
      continue-on-error: false

  test-typescript:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: extension
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: extension/package-lock.json
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run TypeScript tests
      run: npm test -- --passWithNoTests --forceExit

  docker-build:
    runs-on: ubuntu-latest
    needs: [test-python]
    name: Docker Build Check
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image (no push)
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: payguard:ci-${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  security-scan:
    runs-on: ubuntu-latest
    name: Dependency Security Scan
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install pip-audit
      run: pip install pip-audit

    - name: Audit dependencies
      run: pip-audit -r requirements.txt --ignore-vuln PYSEC-2024-* || true
      # `|| true` so the build doesn't hard-fail on known low-severity CVEs;
      # review output manually for critical issues.
