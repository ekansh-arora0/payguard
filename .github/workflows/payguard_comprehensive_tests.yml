name: PayGuard Comprehensive Test Suite

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        test-suite: [unit, integration, performance, property]
        exclude:
          # Skip performance tests on Windows (different behavior)
          - os: windows-latest
            test-suite: performance
          # Skip property tests on older Python versions
          - python-version: '3.9'
            test-suite: property
    
    services:
      mongodb:
        image: mongo:5.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd mongo
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr
        
    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install tesseract
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements_comprehensive.txt
        
    - name: Set up environment variables
      run: |
        echo "MONGO_URL=mongodb://localhost:27017" >> $GITHUB_ENV
        echo "DB_NAME=payguard_test" >> $GITHUB_ENV
        echo "TESTING=true" >> $GITHUB_ENV
        echo "PAYGUARD_BACKEND_URL=http://localhost:8002" >> $GITHUB_ENV
        
    - name: Start mock backend (for integration tests)
      if: matrix.test-suite == 'integration'
      run: |
        python -c "
        from aiohttp import web
        import asyncio
        import json
        
        async def health_handler(request):
            return web.json_response({'status': 'healthy'})
            
        async def mock_handler(request):
            return web.json_response({'status': 'ok', 'mock': True})
            
        app = web.Application()
        app.router.add_get('/api/health', health_handler)
        app.router.add_route('*', '/{path:.*}', mock_handler)
        
        web.run_app(app, host='localhost', port=8002)
        " &
        sleep 5
        
    - name: Run unit tests
      if: matrix.test-suite == 'unit'
      run: |
        python -m pytest tests/test_payguard_comprehensive_features.py \
          -v --tb=short \
          --cov=test_all_payguard_features_comprehensive_optimized \
          --cov-report=xml \
          --junit-xml=test-results-unit-${{ matrix.os }}-${{ matrix.python-version }}.xml
          
    - name: Run integration tests
      if: matrix.test-suite == 'integration'
      run: |
        python -m pytest tests/test_payguard_features_integration.py \
          -v --tb=short \
          --junit-xml=test-results-integration-${{ matrix.os }}-${{ matrix.python-version }}.xml
          
    - name: Run performance tests
      if: matrix.test-suite == 'performance'
      run: |
        python -m pytest tests/test_payguard_features_performance.py \
          -v --tb=short -s \
          --junit-xml=test-results-performance-${{ matrix.os }}-${{ matrix.python-version }}.xml
          
    - name: Run property-based tests
      if: matrix.test-suite == 'property'
      run: |
        python -m pytest tests/test_payguard_features_property.py \
          -v --tb=short \
          --hypothesis-show-statistics \
          --junit-xml=test-results-property-${{ matrix.os }}-${{ matrix.python-version }}.xml
          
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.test-suite }}-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          test-results-*.xml
          coverage.xml
          htmlcov/
          test-report.html
          
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.test-suite == 'unit' && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  feature-tests:
    runs-on: ubuntu-latest
    needs: test-matrix
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    services:
      mongodb:
        image: mongo:5.0
        ports:
          - 27017:27017
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements_comprehensive.txt
        
    - name: Start mock backend
      run: |
        python -c "
        from aiohttp import web
        import asyncio
        
        async def health_handler(request):
            return web.json_response({'status': 'healthy', 'uptime': '1h'})
            
        async def risk_handler(request):
            data = await request.json()
            return web.json_response({
                'url': data.get('url', ''),
                'risk_level': 'low',
                'trust_score': 85
            })
            
        app = web.Application()
        app.router.add_get('/api/health', health_handler)
        app.router.add_post('/api/risk-check', risk_handler)
        app.router.add_route('*', '/{path:.*}', lambda r: web.json_response({'mock': True}))
        
        web.run_app(app, host='localhost', port=8002)
        " &
        sleep 5
        
    - name: Run optimized feature tests
      run: |
        python test_all_payguard_features_comprehensive_optimized.py
        
    - name: Upload feature test results
      uses: actions/upload-artifact@v3
      with:
        name: feature-test-results
        path: |
          payguard_comprehensive_test_results.json
          performance_report.json

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 mypy black isort bandit safety
        pip install -r requirements.txt
        
    - name: Run flake8
      run: |
        flake8 test_all_payguard_features_comprehensive_optimized.py \
          --max-line-length=100 \
          --ignore=E203,W503 \
          --format='::error file=%(path)s,line=%(row)d,col=%(col)d::%(code)s: %(text)s'
          
    - name: Run mypy
      run: |
        mypy test_all_payguard_features_comprehensive_optimized.py \
          --ignore-missing-imports \
          --no-error-summary
          
    - name: Check code formatting with black
      run: |
        black --check --diff test_all_payguard_features_comprehensive_optimized.py
        
    - name: Check import sorting with isort
      run: |
        isort --check-only --diff test_all_payguard_features_comprehensive_optimized.py
        
    - name: Run bandit security linter
      run: |
        bandit -r test_all_payguard_features_comprehensive_optimized.py \
          -f json -o bandit-report.json
      continue-on-error: true
      
    - name: Run safety check
      run: |
        safety check --json --output safety-report.json
      continue-on-error: true
      
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  comprehensive-test:
    runs-on: ubuntu-latest
    needs: [test-matrix, code-quality]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements_comprehensive.txt
        
    - name: Run comprehensive test suite
      run: |
        python run_payguard_comprehensive_tests.py --suite all
        
    - name: Upload comprehensive test report
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-test-report
        path: |
          payguard_comprehensive_test_report.json
          test_results_*.xml
          htmlcov/

  notify-results:
    runs-on: ubuntu-latest
    needs: [test-matrix, feature-tests, code-quality, comprehensive-test]
    if: always()
    
    steps:
    - name: Notify on success
      if: needs.test-matrix.result == 'success' && needs.code-quality.result == 'success'
      run: |
        echo "✅ All PayGuard comprehensive tests passed!"
        
    - name: Notify on failure
      if: needs.test-matrix.result == 'failure' || needs.code-quality.result == 'failure'
      run: |
        echo "❌ Some PayGuard tests failed. Check the logs for details."
        exit 1